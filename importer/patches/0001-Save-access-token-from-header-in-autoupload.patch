From f4d4122982dc51d3efc013b25f14571fa09e8a0a Mon Sep 17 00:00:00 2001
From: George Garside <apps@georgegarside.com>
Date: Fri, 2 May 2025 23:51:22 +0100
Subject: [PATCH] Save access token from header in /autoupload

---
 app/Console/HaveAccess.php                    | 8 ++++----
 app/Http/Controllers/AutoUploadController.php | 6 ++++--
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/app/Console/HaveAccess.php b/app/Console/HaveAccess.php
index b7738017..a824e758 100644
--- a/app/Console/HaveAccess.php
+++ b/app/Console/HaveAccess.php
@@ -34,7 +34,7 @@ use GrumpyDictator\FFIIIApiSupport\Response\SystemInformationResponse;
  */
 trait HaveAccess
 {
-    private function haveAccess(): bool
+    private function haveAccess(): string
     {
         $url             = (string) config('importer.url');
         $token           = (string) config('importer.access_token');
@@ -61,7 +61,7 @@ trait HaveAccess
             $this->error(sprintf('ApiHttpException: Could not connect to Firefly III at %s: %s', $url, $e->getMessage()));
             $this->error(sprintf('The last 25 chars of the access token are: %s', substr($token, -25)));
 
-            return false;
+            return '';
         }
         $reportedVersion = $result->version;
         if (str_starts_with($reportedVersion, 'v')) {
@@ -84,10 +84,10 @@ trait HaveAccess
         if (-1 === $compare && !str_starts_with($reportedVersion, 'develop') && !str_starts_with($reportedVersion, 'branch')) {
             $this->error(sprintf('The data importer cannot communicate with Firefly III v%s. Please upgrade to Firefly III v%s or higher.', $reportedVersion, config('importer.minimum_version')));
 
-            return false;
+            return '';
         }
 
-        return true;
+        return $token;
     }
 
     /**
diff --git a/app/Http/Controllers/AutoUploadController.php b/app/Http/Controllers/AutoUploadController.php
index 563a7472..f789bbfb 100644
--- a/app/Http/Controllers/AutoUploadController.php
+++ b/app/Http/Controllers/AutoUploadController.php
@@ -30,6 +30,7 @@ use App\Console\HaveAccess;
 use App\Console\VerifyJSON;
 use App\Exceptions\ImporterErrorException;
 use App\Http\Request\AutoUploadRequest;
+use App\Services\Shared\Authentication\SecretManager;
 
 class AutoUploadController extends Controller
 {
@@ -52,10 +53,11 @@ class AutoUploadController extends Controller
             throw new ImporterErrorException('Bad secret, not allowed to import.');
         }
 
-        $access         = $this->haveAccess();
-        if (false === $access) {
+        $token          = $this->haveAccess();
+        if (false === $token) {
             throw new ImporterErrorException(sprintf('Could not connect / get access to your local Firefly III instance at %s.', config('importer.url')));
         }
+        SecretManager::saveAccessToken($token);
 
         $json           = $request->file('json');
         $importable     = $request->file('importable');
-- 
2.48.1

